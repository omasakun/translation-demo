<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ—¥æœ¬èªâ‡„è‹±èªç¿»è¨³ã‚¢ãƒ—ãƒª</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="ç¿»è¨³ã‚¢ãƒ—ãƒª" />

    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192x192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512x512.png" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        color: #333;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        padding: 40px;
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
      }

      .header h1 {
        font-size: 2.5rem;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 10px;
      }

      .header p {
        color: #666;
        font-size: 1.1rem;
      }

      .translation-section {
        display: grid;
        grid-template-columns: 1fr 80px 1fr;
        gap: 20px;
        align-items: start;
        margin-bottom: 30px;
      }

      .input-section,
      .output-section {
        display: flex;
        flex-direction: column;
      }

      .label {
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
        font-size: 1.1rem;
      }

      .textarea {
        width: 100%;
        min-height: 150px;
        padding: 20px;
        border: 2px solid #e1e5e9;
        border-radius: 12px;
        font-size: 16px;
        font-family: inherit;
        resize: vertical;
        transition: all 0.3s ease;
        line-height: 1.6;
      }

      .textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .textarea[readonly] {
        background-color: #f8f9fa;
        cursor: default;
      }

      .translate-button {
        align-self: center;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        cursor: pointer;
        font-size: 24px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      .translate-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      .translate-button:active {
        transform: translateY(0);
      }

      .translate-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .api-key-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 30px;
      }

      .api-key-section h3 {
        color: #333;
        margin-bottom: 15px;
        font-size: 1.2rem;
      }

      .api-key-input {
        width: 100%;
        padding: 15px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 14px;
        font-family: "Monaco", "Consolas", monospace;
        transition: border-color 0.3s ease;
      }

      .api-key-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .error-message {
        background: #fee;
        color: #c33;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .usage-info {
        background: #e8f4fd;
        padding: 20px;
        border-radius: 12px;
        margin-top: 20px;
      }

      .usage-info h4 {
        color: #1976d2;
        margin-bottom: 10px;
      }

      .usage-info p {
        color: #666;
        line-height: 1.6;
        margin-bottom: 8px;
      }

      .usage-info a {
        color: #2196f3;
        text-decoration: none;
      }

      .usage-info a:hover {
        text-decoration: underline;
      }

      .api-setup-guide {
        background: #e8f4fd;
        border: 1px solid #90cdf4;
        border-radius: 12px;
        margin-top: 15px;
        overflow: hidden;
      }

      .guide-header {
        background: #bee3f8;
        padding: 15px 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: background-color 0.3s ease;
      }

      .guide-header:hover {
        background: #90cdf4;
      }

      .guide-header h5 {
        margin: 0;
        color: #1976d2;
        font-size: 1.1rem;
      }

      .guide-toggle {
        font-size: 1.2rem;
        color: #1976d2;
        transition: transform 0.3s ease;
      }

      .guide-toggle.expanded {
        transform: rotate(180deg);
      }

      .guide-content {
        padding: 0 20px;
        max-height: 0;
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .guide-content.expanded {
        max-height: 1000px;
        padding: 20px;
      }

      .guide-step {
        margin-bottom: 15px;
        padding-left: 25px;
        position: relative;
      }

      .guide-step::before {
        content: counter(step-counter);
        counter-increment: step-counter;
        position: absolute;
        left: 0px;
        top: 5px;
        background: #2196f3;
        color: white;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
      }

      .guide-steps {
        counter-reset: step-counter;
      }

      .guide-step strong {
        color: #1976d2;
      }

      .guide-link {
        color: #2196f3;
        text-decoration: none;
        font-weight: 500;
      }

      .guide-link:hover {
        text-decoration: underline;
      }

      .warning-box {
        background: #fff5f5;
        border: 1px solid #feb2b2;
        border-radius: 8px;
        padding: 12px;
        margin: 10px 0;
      }

      .warning-box p {
        margin: 0;
        color: #c53030;
        font-size: 0.9rem;
      }

      @media (max-width: 768px) {
        .translation-section {
          grid-template-columns: 1fr;
          grid-template-rows: auto auto auto;
          gap: 20px;
        }

        .translate-button {
          justify-self: center;
        }

        .container {
          padding: 20px;
        }

        .header h1 {
          font-size: 2rem;
        }
      }
    </style>
    <script type="importmap">
      {
        "imports": {
          "preact": "https://esm.sh/preact@10.26.9",
          "preact/hooks": "https://esm.sh/preact@10.26.9/hooks",
          "htm/preact": "https://esm.sh/htm@3.1.1/preact",
          "nanostores": "https://esm.sh/nanostores@1.0.1",
          "@nanostores/preact": "https://esm.sh/@nanostores/preact@1.0.0"
        }
      }
    </script>
  </head>
  <body>
    <div id="app"></div>

    <script type="module">
      import { render } from "preact";
      import { html } from "htm/preact";
      import { atom } from "nanostores";
      import { useStore } from "@nanostores/preact";

      // #region ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°

      const getInitialApiKey = () => {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("apikey") || localStorage.getItem("googleTranslateApiKey") || "";
      };

      const translateText = async (japaneseText, apiKey) => {
        const response = await fetch(
          `https://translation.googleapis.com/language/translate/v2?key=${apiKey}`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              q: japaneseText,
              source: "ja",
              target: "en",
              format: "text",
            }),
          }
        );

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(
            errorData.error?.message ||
              `HTTP error! status: ${response.status}`
          );
        }

        const data = await response.json();
        return data.data.translations[0].translatedText;
      };

      // #endregion
      // #region ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒˆã‚¢

      const $apiKey = atom(getInitialApiKey());
      const $japaneseText = atom("");
      const $englishText = atom("");
      const $isLoading = atom(false);
      const $error = atom("");
      const $isGuideExpanded = atom(localStorage.getItem("isGuideExpanded") === "true");

      $apiKey.subscribe((apiKey) => {
        if (apiKey) {
          localStorage.setItem("googleTranslateApiKey", apiKey);
        }
      });

      $isGuideExpanded.subscribe((isExpanded) => {
        localStorage.setItem("isGuideExpanded", isExpanded.toString());
      });

      // #endregion
      // #region ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

      const setApiKey = (apiKey) => $apiKey.set(apiKey);
      const setJapaneseText = (text) => $japaneseText.set(text);
      const setEnglishText = (text) => $englishText.set(text);
      const setError = (error) => $error.set(error);
      const setLoading = (isLoading) => $isLoading.set(isLoading);
      const toggleGuide = () => $isGuideExpanded.set(!$isGuideExpanded.get());

      const translate = async () => {
        const japaneseText = $japaneseText.get();
        const apiKey = $apiKey.get();

        if (!japaneseText.trim()) {
          setError("ç¿»è¨³ã™ã‚‹æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          return;
        }

        if (!apiKey.trim()) {
          setError("Google Translation API ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          return;
        }

        setLoading(true);
        setError("");

        try {
          const translatedText = await translateText(japaneseText, apiKey);
          setEnglishText(translatedText);
        } catch (err) {
          console.error("Translation error:", err);
          setError(`ç¿»è¨³ã‚¨ãƒ©ãƒ¼: ${err.message}`);
        } finally {
          setLoading(false);
        }
      };

      // #endregion
      // #region ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

      const Header = () => {
        return html`
          <div className="header">
            <h1>æ—¥æœ¬èªâ‡„è‹±èªç¿»è¨³</h1>
            <p>Google Translation APIã‚’ä½¿ç”¨ã—ãŸç¿»è¨³ã‚¢ãƒ—ãƒª</p>
          </div>
        `;
      };

      const ApiKeySection = () => {
        const apiKey = useStore($apiKey);

        return html`
          <div className="api-key-section">
            <h3>Google Translation API ã‚­ãƒ¼</h3>
            <input
              type="password"
              placeholder="AIzaSy..."
              value=${apiKey}
              onInput=${(e) => setApiKey(e.target.value)}
              className="api-key-input"
            />
          </div>
        `;
      };

      const TranslateButton = () => {
        const isLoading = useStore($isLoading);

        return html`
          <button
            onClick=${translate}
            className="translate-button"
            title="Ctrl+Enter ã§ã‚‚ç¿»è¨³ã§ãã¾ã™"
            disabled=${isLoading}
          >
            ${isLoading ? html`<div className="loading"></div>` : "â”"}
          </button>
        `;
      };

      const TextArea = ({ label, placeholder, value, onInput, onKeyDown, readOnly = false }) => {
        return html`
          <div className=${readOnly ? "output-section" : "input-section"}>
            <div className="label">${label}</div>
            <textarea
              placeholder=${placeholder}
              value=${value}
              onInput=${onInput}
              onKeyDown=${onKeyDown}
              readonly=${readOnly}
              className="textarea"
            ></textarea>
          </div>
        `;
      };

      const TranslationSection = () => {
        const japaneseText = useStore($japaneseText);
        const englishText = useStore($englishText);

        const handleKeyPress = (e) => {
          if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            translate();
          }
        };

        return html`
          <div className="translation-section">
            <${TextArea}
              label="æ—¥æœ¬èª"
              placeholder="ç¿»è¨³ã—ãŸã„æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
              value=${japaneseText}
              onInput=${(e) => setJapaneseText(e.target.value)}
              onKeyDown=${handleKeyPress}
            />

            <${TranslateButton} />

            <${TextArea}
              label="è‹±èª"
              placeholder="ç¿»è¨³çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™..."
              value=${englishText}
              readOnly=${true}
            />
          </div>
        `;
      };

      const ErrorMessage = () => {
        const error = useStore($error);

        if (!error) return null;

        return html`
          <div className="error-message">${error}</div>
        `;
      };

      const GuideLink = ({ href, children }) => {
        return html`
          <a
            href=${href}
            target="_blank"
            rel="noopener noreferrer"
            className="guide-link"
          >
            ${children}
          </a>
        `;
      };

      const ApiSetupGuide = () => {
        const isGuideExpanded = useStore($isGuideExpanded);

        return html`
          <div className="api-setup-guide">
            <div className="guide-header" onClick=${toggleGuide}>
              <h5>APIã‚­ãƒ¼ã®å–å¾—æ–¹æ³•</h5>
              <span className=${`guide-toggle ${isGuideExpanded ? "expanded" : ""}`}>
                â–¼
              </span>
            </div>

            <div className=${`guide-content ${isGuideExpanded ? "expanded" : ""}`}>
              <div className="guide-steps">
                <div className="guide-step">
                  <strong>Google Cloud ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</strong>
                  <br />
                  Google Cloud ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒãªã„å ´åˆã¯
                  <${GuideLink} href="https://console.cloud.google.com/freetrial">
                    ã“ã¡ã‚‰
                  <//>
                  ã‹ã‚‰ç„¡æ–™ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ
                </div>

                <div className="guide-step">
                  <strong>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆãƒ»é¸æŠ</strong>
                  <br />
                  <${GuideLink} href="https://console.cloud.google.com/projectselector2/home/dashboard">
                    Google Cloud Console
                  <//>
                  ã§æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹ã‹ã€æ—¢å­˜ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
                </div>

                <div className="guide-step">
                  <strong>è«‹æ±‚å…ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š</strong>
                  <br />
                  ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«è«‹æ±‚å…ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è¨­å®šï¼ˆç„¡æ–™æ å†…ã§ã‚‚åˆ©ç”¨å¯èƒ½ï¼‰
                  <div className="warning-box">
                    <p>
                      âš ï¸ Translation APIã¯å¾“é‡èª²é‡‘åˆ¶ã§ã™ãŒã€æœˆ50ä¸‡æ–‡å­—ã¾ã§ç„¡æ–™ã§ã™
                    </p>
                  </div>
                </div>

                <div className="guide-step">
                  <strong>Translation API æœ‰åŠ¹åŒ–</strong>
                  <br />
                  <${GuideLink} href="https://console.cloud.google.com/flows/enableapi?apiid=translate.googleapis.com">
                    Translation API ã‚’æœ‰åŠ¹åŒ–
                  <//>
                </div>

                <div className="guide-step">
                  <strong>APIã‚­ãƒ¼ä½œæˆ</strong>
                  <br />
                  <${GuideLink} href="https://console.cloud.google.com/apis/credentials">
                    èªè¨¼æƒ…å ±ãƒšãƒ¼ã‚¸
                  <//>
                  â” ã€Œèªè¨¼æƒ…å ±ã‚’ä½œæˆã€â” ã€ŒAPIã‚­ãƒ¼ã€ã‚’é¸æŠ
                </div>

                <div className="guide-step">
                  <strong>APIã‚­ãƒ¼åˆ¶é™è¨­å®šï¼ˆæ¨å¥¨ï¼‰</strong>
                  <br />
                  ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€APIã‚­ãƒ¼ã«åˆ¶é™ã‚’è¨­å®š:
                  <br />
                  â€¢ APIåˆ¶é™: Cloud Translation APIã®ã¿
                  <br />
                  â€¢ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶é™: HTTPãƒªãƒ•ã‚¡ãƒ©ãƒ¼ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
                </div>

                <div className="guide-step">
                  <strong>APIã‚­ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼</strong>
                  <br />
                  ä½œæˆã•ã‚ŒãŸAPIã‚­ãƒ¼ï¼ˆAIzaSy...ã®æ–‡å­—åˆ—ï¼‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€ä¸Šè¨˜ã®å…¥åŠ›æ¬„ã«è²¼ã‚Šä»˜ã‘
                </div>
              </div>
            </div>
          </div>
        `;
      };

      const UsageInfo = () => {
        return html`
          <div className="usage-info">
            <h4>ä½¿ã„æ–¹</h4>
            <p>
              1. Google Cloud Console ã§ Translation API
              ã‚’æœ‰åŠ¹ã«ã—ã€APIã‚­ãƒ¼ã‚’å–å¾—ã—ã¦ãã ã•ã„
            </p>
            <p>
              2.
              ä¸Šè¨˜ã®APIã‚­ãƒ¼æ¬„ã«ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼‰
            </p>
            <p>
              3.
              æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã€â”ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯Ctrl+Enterã§ç¿»è¨³
            </p>
            <p>ğŸ’¡ APIã‚­ãƒ¼ã¯URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã‚‚æŒ‡å®šå¯èƒ½ã§ã™: ?apikey=YOUR_API_KEY</p>

            <${ApiSetupGuide} />
          </div>
        `;
      };

      const TranslationApp = () => {
        return html`
          <div className="container">
            <${Header} />
            <${ApiKeySection} />
            <${TranslationSection} />
            <${ErrorMessage} />
            <${UsageInfo} />
          </div>
        `;
      };

      // #endregion

      render(html`<${TranslationApp} />`, document.getElementById("app"));

      // PWA: Service Worker ã®ç™»éŒ²
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
              console.log('SW registered: ', registration);
            })
            .catch((registrationError) => {
              console.log('SW registration failed: ', registrationError);
            });
        });
      }
    </script>
  </body>
</html>
